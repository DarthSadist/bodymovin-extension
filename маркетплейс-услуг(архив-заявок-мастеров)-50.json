{"createdAt":"2023-05-04T00:07:46.717Z","updatedAt":"2023-05-04T01:29:38.000Z","id":"50","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥(–∞—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤)","active":true,"nodes":[{"parameters":{"path":"d7647859-dc21-4e93-a291-4e1308984938","options":{}},"id":"96e68813-5987-45e9-88b8-ff70156818fc","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[80,320],"webhookId":"d7647859-dc21-4e93-a291-4e1308984938"},{"parameters":{"jsCode":"const inputData = items[0].json;\n\n// –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π x, msgid, klient_otvet_order –∏ FIO\nlet xValue;\nlet msgidValue;\nlet klientOtvetOrderValue;\nlet FIOValue;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ª–∏ –æ–±—ä–µ–∫—Ç inputData.query, –∏ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\nif (inputData.query && inputData.query.variables) {\n  inputData.query.variables.forEach((variable) => {\n    if (variable.name === 'x') {\n      xValue = variable.value;\n    } else if (variable.name === 'msgid') {\n      msgidValue = variable.value;\n    } else if (variable.name === 'klient_otvet_order') {\n      klientOtvetOrderValue = variable.value;\n    } else if (variable.name === 'FIO') {\n      FIOValue = variable.value;\n    }\n  });\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ x, msgid, klient_otvet_order –∏ FIO\nreturn [{ json: { x: xValue, msgid: msgidValue, klient_otvet_order: klientOtvetOrderValue, FIO: FIOValue } }];"},"id":"2eb0423d-8270-4130-9389-d93610e719b6","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[220,320]},{"parameters":{"dataType":"string","value1":"={{ $json[\"x\"] }}","rules":{"rules":[{"value2":"1"}]}},"id":"b1da3eb6-49a1-41e7-95dc-e2c032bca731","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":1,"position":[380,320]},{"parameters":{"documentId":{"__rl":true,"value":"1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"–ú–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω","lookupValue":"={{ $json[\"FIO\"] }}"}]},"options":{"returnAllMatches":"returnAllMatches"}},"id":"d283cc59-84cb-4351-8d0a-6059499d96ba","name":"Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[500,220],"alwaysOutputData":true,"credentials":{"googleSheetsOAuth2Api":{"id":"27","name":"Google Sheets account"}}},{"parameters":{"jsCode":"const inputData = items;\n\nconst filteredData = inputData.filter((item) => {\n  const funnelValue = item.json[\"–í–æ—Ä–æ–Ω–∫–∞\"];\n  return (\n    funnelValue === \"8. –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è\" ||\n    funnelValue === \"9. –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É\"\n  );\n});\n\nif (Object.keys($node['Google Sheets'].json).length === 0 || filteredData.length === 0) {\n  return [{json: {isEmpty: true}}];\n} else {\n  return filteredData;\n}"},"id":"6fccfb34-8ee6-4001-8e7a-3471d890fe2a","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,220],"alwaysOutputData":true},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json[\"isEmpty\"] }}","value2":true}]}},"id":"2dcad5b6-c7d3-426c-bf9f-b9c7b4c3fece","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[860,220]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","messageId":"={{ $node[\"Code\"].json[\"msgid\"] }}"},"id":"78dee2f7-4b17-470f-8a28-04bd64056956","name":"Telegram","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[860,40],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","text":"üìÅü§∑‚Äç‚ôÇÔ∏è <b>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç. –ó–∞—è–≤–æ–∫ –Ω–µ—Ç.</b>","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"üîµ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç","additionalFields":{"callback_data":"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"}}]}}]},"additionalFields":{"parse_mode":"HTML"}},"id":"faa042fa-6641-467a-822f-f46d37cd4285","name":"Telegram1","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1000,40],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"jsCode":"let aggregatedText = '';\n\nconst FUNNEL_STATUS_MAP = {\n  '9.': 'üí™ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É',\n  '8.': '‚ùå –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è',\n  '6.': 'üí≥ —Ü–µ–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É',\n  '7.': '‚úÖ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª',\n  '10.': 'ü™õ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É'\n};\n\nfunction formatText(value) {\n  return value ? `<i>${value}</i>` : '–ù–µ—Ç';\n}\n\nitems.forEach(item => {\n  const rowNumber = item.json.row_number;\n  const specialist = item.json['–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];\n  let description = item.json['–ó–∞–¥–∞—á–∞'];\n  let date = item.json['–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞'];\n  let time = item.json['–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞'];\n  let funnel = item.json['–í–æ—Ä–æ–Ω–∫–∞'];\n  const address = item.json['–ê–¥—Ä–µ—Å'];\n  const phone = item.json['–¢–µ–ª–µ—Ñ–æ–Ω'];\n  let cost = '';\n  let additionalMaterials = '';\n  let comment = '';\n  let photo = '';\n  let showAdditionalInfo = false;\n\n  if (funnel === '8. –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è' || funnel === '9. –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É' || funnel === '10. –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É') {\n    date = item.json['–î–∞—Ç–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n    time = item.json['–í—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n    description = item.json['–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç'];\n    cost = formatText(item.json['–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç']);\n    additionalMaterials = formatText(item.json['–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã']);\n    comment = formatText(item.json['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']);\n    photo = formatText(item.json['–§–æ—Ç–æ']);\n  }\n\n  funnel = FUNNEL_STATUS_MAP[funnel.slice(0, 2)] || funnel;\n\n  aggregatedText += `‚û§ <b>–ó–∞—è–≤–∫–∞ ‚Ññ${rowNumber}</b>\\n\\n`;\n  aggregatedText += `‚Ä¢ üë§<b>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</b> ${formatText(specialist)}\\n`;\n  aggregatedText += `‚Ä¢ üìÉ<b>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç:</b> ${formatText(description)}\\n`;\n  aggregatedText += `‚Ä¢ üìÖ<b>–î–∞—Ç–∞:</b> ${formatText(date)}\\n`;\n  aggregatedText += `‚Ä¢ üï∞<b>–í—Ä–µ–º—è:</b> ${formatText(time)}\\n`;\n  aggregatedText += `‚Ä¢ üõ† <b>–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:</b> ${formatText(funnel)}\\n`;\n  aggregatedText += `‚Ä¢ üè† <b>–ê–¥—Ä–µ—Å:</b> ${formatText(address)}\\n`;\n  aggregatedText += `‚Ä¢ ‚òéÔ∏è <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${formatText(phone)}\\n`;\n\n  if (cost) {\n    aggregatedText += `‚Ä¢ üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç:</b> ${cost} ‚ÇΩ\\n`;\n  }\n  \n  if (additionalMaterials) {\n    aggregatedText += `‚Ä¢ üõí <b>–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b> ${additionalMaterials}\\n`;\n  }\n  \n  if (comment) {\n    aggregatedText += `‚Ä¢ üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${comment}\\n`;\n  }\n  \n  if (photo) {\n    aggregatedText += `‚Ä¢ üì∑ <b>–§–æ—Ç–æ:</b> ${photo}\\n`;\n  }\n\n  aggregatedText += '\\n';\n});\n\nreturn [{ json: { aggregatedText } }];"},"id":"2cad18d3-f78a-4ab6-b6e5-bffbbbfa4e7b","name":"Code2","type":"n8n-nodes-base.code","typeVersion":1,"position":[1080,220]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","messageId":"={{ $node[\"Code\"].json[\"msgid\"] }}"},"id":"c2755649-6746-4216-8f72-d22712d31eb9","name":"Telegram2","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1220,220],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","text":"=üìÅüëÄ <b>–ó–∞—è–≤–∫–∏ –≤ –∞—Ä—Ö–∏–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π.</b> üíªüí∞\n\n{{ $node[\"Code2\"].json[\"aggregatedText\"] }}","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"üîµ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç","additionalFields":{"callback_data":"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"}}]}}]},"additionalFields":{"parse_mode":"HTML"}},"id":"e3e1bd1b-9c80-4e33-a1c6-b2fc982d889e","name":"Telegram3","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1400,220],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Google Sheets":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"Telegram","type":"main","index":0}],[{"node":"Code2","type":"main","index":0}]]},"Telegram":{"main":[[{"node":"Telegram1","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Telegram2","type":"main","index":0}]]},"Telegram2":{"main":[[{"node":"Telegram3","type":"main","index":0}]]}},"settings":{},"staticData":null,"meta":null,"pinData":{},"versionId":"c4688fce-5ba3-4502-9731-c11916a034ee","triggerCount":1,"tags":[]}