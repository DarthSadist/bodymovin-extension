{"createdAt":"2023-05-06T08:51:56.272Z","updatedAt":"2023-05-06T10:21:16.000Z","id":"51","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥(–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É)","active":true,"nodes":[{"parameters":{"path":"49cfdd9c-e936-4308-8462-1c0b4efff8b1","options":{}},"id":"54c77a2c-5277-46dc-b9a0-90778869a200","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[80,380],"webhookId":"49cfdd9c-e936-4308-8462-1c0b4efff8b1"},{"parameters":{"jsCode":"// –ü–æ–ª—É—á–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst inputData = items[0].json;\n\n// –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π z, msgid –∏ FIO\nlet zValue;\nlet msgidValue;\nlet fioValue;\nlet masterOtvetNewOrderValue;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ª–∏ –æ–±—ä–µ–∫—Ç inputData.query, –∏ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\nif (inputData.query && inputData.query.variables) {\ninputData.query.variables.forEach((variable) => {\nif (variable.name === 'z') {\nzValue = variable.value;\n} else if (variable.name === 'msgid') {\nmsgidValue = variable.value;\n} else if (variable.name === 'FIO') {\nfioValue = variable.value;\n} else if (variable.name === 'master_otvet_neworder') {\nmasterOtvetNewOrderValue = variable.value;\n}\n});\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ y, msgid, FIO –∏ master_otvet_neworder\nreturn [{ json: { z: zValue, msgid: msgidValue, FIO: fioValue, master_otvet_neworder: masterOtvetNewOrderValue } }];"},"id":"24d4549a-c5bb-42a5-8487-dab011da8dd4","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[220,380]},{"parameters":{"jsCode":"return new Promise((resolve) => {\n  setTimeout(() => {\n    resolve({ });\n  }, 5000);\n});"},"id":"9cfb0d38-5dd0-4141-bc42-690bcd0ec028","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[360,380]},{"parameters":{"documentId":{"__rl":true,"value":"1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è","lookupValue":"={{ $node[\"Code\"].json[\"master_otvet_neworder\"] }}"}]},"options":{}},"id":"398cbc83-7251-46f6-b55e-3adb6a0f1a64","name":"Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[500,380],"credentials":{"googleSheetsOAuth2Api":{"id":"27","name":"Google Sheets account"}}},{"parameters":{"jsCode":"let aggregatedText = '';\n\nitems.forEach(item => {\n  const rowNumber = item.json.row_number;\n  const specialist = item.json['–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];\n  let description = item.json['–ó–∞–¥–∞—á–∞'];\n  let date = item.json['–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞'];\n  let time = item.json['–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞'];\n  let funnel = item.json['–í–æ—Ä–æ–Ω–∫–∞'];\n  const masterAppointed = item.json['–ú–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω'];\n  let cost = '';\n  let additionalMaterials = '';\n  let comment = '';\n  let photo = '';\n  let showAdditionalInfo = false;\n\n  if (funnel === \"6. —Ü–µ–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É\") {\n      date = item.json['–î–∞—Ç–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n      time = item.json['–í—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n      description = item.json['–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç'];\n      cost = item.json['–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç'] || \"–ù–µ—Ç\";\n      additionalMaterials = item.json['–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã'] || \"–ù–µ—Ç\";\n      comment = item.json['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] || \"–ù–µ—Ç\";\n      photo = item.json['–§–æ—Ç–æ'] || \"–ù–µ—Ç\";\n  } else if (funnel === \"7. –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª\" || funnel === \"10. –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É\") {\n      cost = item.json['–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç'] || \"–ù–µ—Ç\";\n      additionalMaterials = item.json['–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã'] || \"–ù–µ—Ç\";\n      comment = item.json['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] || \"–ù–µ—Ç\";\n      photo = item.json['–§–æ—Ç–æ'] || \"–ù–µ—Ç\";\n      showAdditionalInfo = true;\n  } else if (funnel === \"3. –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–∞—Å—Ç–µ—Ä–∞–º\") {\n      funnel = 'ü´¥ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–∞—Å—Ç–µ—Ä–∞–º';\n  }\n\n  if (funnel.startsWith('4.')) {\n    funnel = 'üìù –º–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω';\n  } else if (funnel.startsWith('5.')) {\n    funnel = 'üö∂ 1—ã–π –≤–∏–∑–∏—Ç –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω';\n  } else if (funnel.startsWith('6.')) {\n    funnel = 'üí≥ —Ü–µ–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É';\n  } else if (funnel.startsWith('7.')) {\n    funnel = '‚úÖ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª';\n  } else if (funnel.startsWith('10.')) {\n    funnel = 'üîß –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É';\n  }\n\n  aggregatedText += `‚û§ <b>–ó–∞—è–≤–∫–∞ ‚Ññ${rowNumber}</b>\\n\\n`;\n  aggregatedText += `‚Ä¢ üë§<b>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</b> <i>${specialist}</i>\\n`;\n  aggregatedText += `‚Ä¢ üìÉ<b>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç:</b> <i>${description}</i>\\n`;\n  aggregatedText += `‚Ä¢ üìÖ<b>–î–∞—Ç–∞:</b> <i>${date}</i>\\n`;\n  aggregatedText += `‚Ä¢ üï∞<b>–í—Ä–µ–º—è:</b> <i>${time}</i>\\n`;\n  aggregatedText += `‚Ä¢ üõ† <b>–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:</b> <i>${funnel}</i>\\n`;\n\n  if (cost) {\n    aggregatedText += `‚Ä¢ üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç:</b> <i>${cost}</i>\\n`;\n  }\n  \n  if (additionalMaterials) {\n    aggregatedText += `‚Ä¢ üõí <b>–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b> <i>${additionalMaterials}</i>\\n`;\n  }\n  \n  if (comment) {\n    aggregatedText += `‚Ä¢ üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> <i>${comment}</i>\\n`;\n  }\n  \n  if (photo) {\n    aggregatedText += `‚Ä¢ üì∑ <b>–§–æ—Ç–æ:</b> <i>${photo}</i>\\n`;\n  }\n\n  if (showAdditionalInfo && masterAppointed) {\n    aggregatedText += `‚Ä¢ üß∞ <b>–ú–∞—Å—Ç–µ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</b><i>üëã ${masterAppointed}</i>\\n`;\n  } else if (masterAppointed) {\n    aggregatedText += `‚Ä¢ üß∞ <b>–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω –º–∞—Å—Ç–µ—Ä: </b><i>üëã ${masterAppointed}</i>\\n`;\n  }\n\n  aggregatedText += '\\n';\n});\n\nreturn [{json: {aggregatedText: aggregatedText}}];"},"id":"718e62b6-3248-4db8-b295-16369e01068a","name":"Code2","type":"n8n-nodes-base.code","typeVersion":1,"position":[640,380]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","messageId":"={{ $node[\"Code\"].json[\"msgid\"] }}"},"id":"86fb0455-bb8d-4cf8-a338-2642b42b5500","name":"Telegram","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[780,380],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","text":"=<b>–ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å \"–í—ã–ø–æ–Ω–µ–Ω–æ\" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–∫–∞–∑—á–∏–∫—É</b>\n\n{{ $node[\"Code2\"].json[\"aggregatedText\"] }}\n\n\n\n<i> üì£–ñ–¥–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–ø–æ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ ‚úÖ –∏–ª–∏ –µ—Å–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ –ø–æ—Å—á–∏—Ç–∞–µ—Ç –Ω—É–∂–Ω—ã–º –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É üõ†</i>","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"üîµ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç","additionalFields":{"callback_data":"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"}}]}}]},"additionalFields":{"parse_mode":"HTML"}},"id":"e2953542-49b2-450d-989f-515484a91a5b","name":"Telegram1","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[920,380],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"chatId":"={{ $node[\"Google Sheets\"].json[\"Telegram ID\"] }}","text":"=<b>üîî –ú–∞—Å—Ç–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –í–∞—à–∏–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å \"–í—ã–ø–æ–ª–Ω–µ–Ω–æ\" ‚úÖ</b>\n\n{{ $node[\"Code2\"].json[\"aggregatedText\"] }}\n\n\n<i>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å \"–í—ã–ø–æ–ª–Ω–µ–Ω–æ\" –ª–∏–±–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</i>\n\nüì¢<b>–í–ê–ñ–ù–û</b>: <i>—á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\" ! –ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –º–æ–∂–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ \"–ú–µ–Ω—é\", —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–π –≤ –Ω–∏–∂–Ω–µ–º –ª–µ–≤–æ–º —É–≥–ª—É.</i>","additionalFields":{"parse_mode":"HTML"}},"id":"108f9689-e0eb-48ab-928a-6e2ea12e53e7","name":"Telegram2","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1060,380],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"method":"POST","url":"https://app.leadteh.ru/api/v1/setContactVariable","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-Requested-With","value":"XMLHttpRequest"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"api_token","value":"z3NKDDweLVTcwVNafiHKJUjwcSfTs17D2iGEzgmcIee9oclBLL5xRvqgGIVJ"},{"name":"contact_id","value":"={{ $node[\"Google Sheets\"].json[\"ID LT\"] }}"},{"name":"name","value":"notification"},{"name":"value","value":"‚ùå –£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"},{"name":"deletable","value":"0"}]},"options":{"response":{"response":{"fullResponse":true,"neverError":true,"responseFormat":"text"}}}},"id":"6173f948-e966-4263-a304-914cb9c31ba1","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[1340,380],"credentials":{"httpBasicAuth":{"id":"35","name":"Unnamed credential"}}},{"parameters":{"method":"POST","url":"https://app.leadteh.ru/api/v1/setContactVariable","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-Requested-With","value":"XMLHttpRequest"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"api_token","value":"z3NKDDweLVTcwVNafiHKJUjwcSfTs17D2iGEzgmcIee9oclBLL5xRvqgGIVJ"},{"name":"contact_id","value":"={{ $node[\"Google Sheets\"].json[\"ID LT\"] }}"},{"name":"name","value":"notification_master_id"},{"name":"value","value":"={{ $node[\"Code3\"].json[\"message_id\"] }}"},{"name":"deletable","value":"0"}]},"options":{"response":{"response":{"fullResponse":true,"neverError":true,"responseFormat":"text"}}}},"id":"a64f96d2-d89d-4c57-9438-7285709ced97","name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[1480,380],"credentials":{"httpBasicAuth":{"id":"35","name":"Unnamed credential"}}},{"parameters":{"jsCode":"let message_id = $node[\"Telegram2\"].json[\"result\"][\"message_id\"].toString();\nreturn { message_id }"},"id":"6712e116-c382-4936-9b33-6f544ed6e02a","name":"Code3","type":"n8n-nodes-base.code","typeVersion":1,"position":[1200,380]}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Google Sheets":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Telegram","type":"main","index":0}]]},"Telegram":{"main":[[{"node":"Telegram1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"Telegram2":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Telegram1":{"main":[[{"node":"Telegram2","type":"main","index":0}]]}},"settings":{},"staticData":null,"meta":null,"pinData":{},"versionId":"585cb328-a785-48d5-886c-27771bc8de12","triggerCount":1,"tags":[]}