{"createdAt":"2023-05-01T21:14:43.180Z","updatedAt":"2023-05-04T01:03:11.000Z","id":"49","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥(–∞—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞)","active":true,"nodes":[{"parameters":{"path":"ad373117-bab0-45bc-8aaf-043a62022b20","options":{}},"id":"e07b016b-02b5-49ba-b8db-6cbc169d5e4e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-240,320],"webhookId":"ad373117-bab0-45bc-8aaf-043a62022b20"},{"parameters":{"jsCode":"const inputData = items[0].json;\n\n// –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π x, msgid –∏ klient_otvet_order\nlet xValue;\nlet msgidValue;\nlet klientOtvetOrderValue;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ª–∏ –æ–±—ä–µ–∫—Ç inputData.query, –∏ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\nif (inputData.query && inputData.query.variables) {\n  inputData.query.variables.forEach((variable) => {\n    if (variable.name === 'x') {\n      xValue = variable.value;\n    } else if (variable.name === 'msgid') {\n      msgidValue = variable.value;\n    } else if (variable.name === 'klient_otvet_order') {\n      klientOtvetOrderValue = variable.value;\n    }\n  });\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ x, msgid –∏ klient_otvet_order\nreturn [{ json: { x: xValue, msgid: msgidValue, klient_otvet_order: klientOtvetOrderValue } }];"},"id":"6bd636a5-a34f-4bb7-af02-87451c6d0da7","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[-100,320]},{"parameters":{"dataType":"string","value1":"={{ $json[\"x\"] }}","rules":{"rules":[{"value2":"1"}]}},"id":"1d64564f-eec7-403e-9ed5-19c4feba78ad","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":1,"position":[40,320]},{"parameters":{"documentId":{"__rl":true,"value":"1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞—Ä–∫–µ—Ç–ø–ª—ç–π—Å —É—Å–ª—É–≥)","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1_mVTlW_BvNIQ30QbtAC59sPq3-ynnggfG01WI4A0WjE/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"Telegram ID","lookupValue":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}"}]},"options":{"returnAllMatches":"returnAllMatches"}},"id":"2d032c08-94ed-4243-96af-364c729de997","name":"Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[220,200],"credentials":{"googleSheetsOAuth2Api":{"id":"27","name":"Google Sheets account"}}},{"parameters":{"operation":"deleteMessage","chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","messageId":"={{ $node[\"Code\"].json[\"msgid\"] }}"},"id":"93e7d868-c7ad-47f7-bef5-59fb837fcfe7","name":"Telegram","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[880,200],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","text":"=üìÅüëÄ <b>–ó–∞—è–≤–∫–∏ –≤ –∞—Ä—Ö–∏–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π.</b> üíªüí∞\n\n{{ $node[\"text\"].json[\"aggregatedText\"] }}","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"üîµ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç","additionalFields":{"callback_data":"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"}}]}}]},"additionalFields":{"parse_mode":"HTML"}},"id":"cf33b60c-9a5a-4d6c-bc02-5993b7f237cb","name":"Telegram1","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1020,200],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}}},{"parameters":{"jsCode":"let aggregatedText = '';\n\nconst FUNNEL_STATUS_MAP = {\n  '9.': 'üí™ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É',\n  '8.': '‚ùå –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è',\n  '6.': 'üí≥ —Ü–µ–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É',\n  '7.': '‚úÖ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª',\n  '10.': 'ü™õ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É'\n};\n\nfunction formatText(value) {\n  return value ? `<i>${value}</i>` : '–ù–µ—Ç';\n}\n\nitems.forEach(item => {\n  const rowNumber = item.json.row_number;\n  const specialist = item.json['–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'];\n  let description = item.json['–ó–∞–¥–∞—á–∞'];\n  let date = item.json['–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞'];\n  let time = item.json['–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞'];\n  let funnel = item.json['–í–æ—Ä–æ–Ω–∫–∞'];\n  const masterAppointed = item.json['–ú–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω'];\n  let cost = '';\n  let additionalMaterials = '';\n  let comment = '';\n  let photo = '';\n  let showAdditionalInfo = false;\n\n  if (funnel === '8. –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è' || funnel === '9. –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É' || funnel === '10. –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É') {\n      date = item.json['–î–∞—Ç–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n      time = item.json['–í—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è'];\n      description = item.json['–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç'];\n      cost = formatText(item.json['–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç']);\n      additionalMaterials = formatText(item.json['–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã']);\n      comment = formatText(item.json['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']);\n      photo = formatText(item.json['–§–æ—Ç–æ']);\n  }\n\n  funnel = FUNNEL_STATUS_MAP[funnel.slice(0, 2)] || funnel;\n\n  aggregatedText += `‚û§ <b>–ó–∞—è–≤–∫–∞ ‚Ññ${rowNumber}</b>\\n\\n`;\n  aggregatedText += `‚Ä¢ üë§<b>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</b> ${formatText(specialist)}\\n`;\n  aggregatedText += `‚Ä¢ üìÉ<b>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç:</b> ${formatText(description)}\\n`;\n  aggregatedText += `‚Ä¢ üìÖ<b>–î–∞—Ç–∞:</b> ${formatText(date)}\\n`;\n  aggregatedText += `‚Ä¢ üï∞<b>–í—Ä–µ–º—è:</b> ${formatText(time)}\\n`;\n  aggregatedText += `‚Ä¢ üõ† <b>–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:</b> ${formatText(funnel)}\\n`;\n\n  if (cost) {\n    aggregatedText += `‚Ä¢ üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç:</b> ${cost} ‚ÇΩ\\n`;\n  }\n  \n  if (additionalMaterials) {\n    aggregatedText += `‚Ä¢ üõí <b>–î–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b> ${additionalMaterials}\\n`;\n  }\n  \n  if (comment) {\n    aggregatedText += `‚Ä¢ üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${comment}\\n`;\n  }\n  \n  if (photo) {\n    aggregatedText += `‚Ä¢ üì∑ <b>–§–æ—Ç–æ:</b> ${photo}\\n`;\n  }\n\n  if (showAdditionalInfo && masterAppointed) {\n    aggregatedText += `‚Ä¢ üß∞ <b>–ú–∞—Å—Ç–µ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</b><i>üëã ${masterAppointed}</i>\\n`;\n  } else if (masterAppointed) {\n    aggregatedText += `‚Ä¢ üß∞ <b>–ú–∞—Å—Ç–µ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: </b><i>üëã ${masterAppointed}</i>\\n`;\n  }\n\n  aggregatedText += '\\n';\n});\n\nreturn [{ json: { aggregatedText } }];"},"id":"cb374378-72f6-414f-baab-0521240e17ac","name":"text","type":"n8n-nodes-base.code","typeVersion":1,"position":[740,200]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json[\"isEmpty\"] }}","value2":true}]}},"id":"d00de363-00f7-4eee-a484-47babd1524b1","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[540,200],"alwaysOutputData":false},{"parameters":{"operation":"deleteMessage","chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","messageId":"={{ $node[\"Code\"].json[\"msgid\"] }}"},"id":"33fa750c-afcb-45af-8caf-789d57aeb968","name":"Telegram2","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[520,20],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}},"continueOnFail":true},{"parameters":{"chatId":"={{ $node[\"Webhook\"].json[\"query\"][\"telegram_id\"] }}","text":"=üìÅü§∑‚Äç‚ôÇÔ∏è <b>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç. –ó–∞—è–≤–æ–∫ –Ω–µ—Ç.</b>","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"üîµ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç","additionalFields":{"callback_data":"–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"}}]}}]},"additionalFields":{"parse_mode":"HTML"}},"id":"da2ea7a9-0370-410a-9bbf-34ec6668b8b7","name":"Telegram3","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[680,20],"credentials":{"telegramApi":{"id":"33","name":"–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —É—Å–ª—É–≥–∏"}},"continueOnFail":true},{"parameters":{"jsCode":"const inputData = items;\n\nconst filteredData = inputData.filter((item) => {\n  const funnelValue = item.json[\"–í–æ—Ä–æ–Ω–∫–∞\"];\n  return (\n    funnelValue === \"8. –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è\" ||\n    funnelValue === \"9. –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª —Ä–∞–±–æ—Ç—É\"\n  );\n});\n\nif (Object.keys($node['Google Sheets'].json).length === 0 || filteredData.length === 0) {\n  return [{json: {isEmpty: true}}];\n} else {\n  return filteredData;\n}"},"id":"72dc5f46-6fb7-4bdc-b28f-762d03b98c23","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[360,200]}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Google Sheets":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Telegram":{"main":[[{"node":"Telegram1","type":"main","index":0}]]},"text":{"main":[[{"node":"Telegram","type":"main","index":0}]]},"IF":{"main":[[{"node":"Telegram2","type":"main","index":0}],[{"node":"text","type":"main","index":0}]]},"Telegram2":{"main":[[{"node":"Telegram3","type":"main","index":0}]]},"Code1":{"main":[[{"node":"IF","type":"main","index":0}]]}},"settings":{},"staticData":null,"meta":null,"pinData":{},"versionId":"4d59a838-cfd4-469f-975b-c4c8b4db0424","triggerCount":1,"tags":[]}